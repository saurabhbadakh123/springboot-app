steps:
- checkout: self

# 1. Build and push image
- task: Docker@2
  displayName: 'Build and Push'
  inputs:
    command: 'buildAndPush'
    repository: 'python-app'
    dockerfile: 'Dockerfile'
    containerRegistry: 'python-sc'
    tags: 'latest'

# 2. Deploy to AKS (with fixes)
- task: AzureCLI@2
  displayName: 'Deploy to AKS'
  timeoutInMinutes: 2  # Prevents hanging
  inputs:
    azureSubscription: 'service-connection'
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
      # Get AKS credentials
      az aks get-credentials \
        --resource-group pythonapp-rg \
        --name pythonapp-aks \
        --overwrite-existing

      # Apply deployment (absolute path)
      kubectl apply -f $(Build.SourcesDirectory)/k8s-deployment.yml

      # Quick verification (no -w flag)
      kubectl get pods
      echo "Deployment completed successfully"
