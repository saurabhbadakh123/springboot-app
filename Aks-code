variables:
  dockerRegistryServiceConnection: 'for-modifiedcode'  # Azure DevOps service connection name
  imageRepository: 'springboot-app'
  containerRegistry: 'myacrrepo7066.azurecr.io'
  dockerfilePath: 'springboot-app-main/Dockerfile'
  tag: '$(Build.BuildNumber)'  # Ensure this matches CD's expected format
  acrLoginServer: 'myacrrepo7066.azurecr.io'
  imageName: 'springboot-app'

pool:
  vmImage: 'ubuntu-latest'

steps:
- task: Maven@3
  inputs:
    mavenPomFile: 'springboot-app-main/pom.xml'
    goals: 'package'
    publishJUnitResults: true
    testResultsFiles: '**/surefire-reports/TEST-*.xml'
  displayName: 'Build Spring Boot App'

- task: Docker@2
  displayName: 'Build Docker Image'
  inputs:
    command: 'build'
    repository: '$(imageRepository)'
    dockerfile: '$(dockerfilePath)'
    containerRegistry: '$(dockerRegistryServiceConnection)'
    tags: |
      $(tag)

- task: Docker@2
  displayName: 'Push Docker Image'
  inputs:
    command: 'push'
    repository: '$(imageRepository)'
    containerRegistry: '$(dockerRegistryServiceConnection)'
    tags: |
      $(tag)
