trigger: none

resources:
  pipelines:
  - pipeline: buildPipeline
    source: Web_Application
    trigger: none

variables:
  imageName: 'springboot-app'
  tag: '$(Build.BuildNumber)'  # Ensure this matches CI's tag format
  acrLoginServer: 'myacrrepo7066.azurecr.io'

pool:
  vmImage: 'ubuntu-latest'

stages:
- stage: Deploy
  displayName: Deploy to AKS
  jobs:
  - job: Deploy
    displayName: Deploy Spring Boot App to AKS
    steps:
    - checkout: self

    # Step 1: Verify the image exists in ACR
    - task: AzureCLI@2
      displayName: 'Verify ACR Image Exists'
      inputs:
        azureSubscription: 'serviceconnection-azurecli'
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          # Fail if the tag doesn't exist
          az acr repository show --name myacrrepo7066 --image springboot-app:$(tag) || exit 1
          echo "Image $(acrLoginServer)/$(imageName):$(tag) exists in ACR."

    # Step 2: Configure AKS credentials
    - task: AzureCLI@2
      displayName: 'Set AKS Context'
      inputs:
        azureSubscription: 'serviceconnection-azurecli'
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          az aks get-credentials --resource-group myResourceGroup --name myAKSCluster --overwrite-existing

    # Step 3: Update deployment YAML with the correct tag
    - script: |
        sed -i "s#__IMAGE_TAG__#$(tag)#g" springboot-app-main/aks-deploy-from-acr.yaml
        echo "Using image: $(acrLoginServer)/$(imageName):$(tag)"
        cat springboot-app-main/aks-deploy-from-acr.yaml  # Debug: Verify replacement
      displayName: 'Update Image Tag in YAML'

    # Step 4: Deploy to AKS
    - task: Kubernetes@1
      displayName: 'Apply Deployment (Dev)'
      inputs:
        connectionType: 'Azure Resource Manager'
        azureSubscriptionEndpoint: 'serviceconnection-azurecli'
        azureResourceGroup: 'myResourceGroup'
        kubernetesCluster: 'myAKSCluster'
        command: 'apply'
        useConfigurationFile: true
        configuration: 'springboot-app-main/aks-deploy-from-acr.yaml'
