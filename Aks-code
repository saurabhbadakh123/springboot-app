trigger:
  branches:
    include:
      - main  # or your default branch

variables:
  dockerRegistryServiceConnection: '<your-service-connection-name>'
  imageRepository: 'springboot-app'
  containerRegistry: 'myacrrepo7066.azurecr.io'
  dockerfilePath: 'Dockerfile'
  tag: '$(Build.BuildId)'

pool:
  vmImage: 'ubuntu-latest'

steps:

- task: Maven@3
  displayName: 'Build Spring Boot App'
  inputs:
    mavenPomFile: 'pom.xml'
    goals: 'package'
    publishJUnitResults: true
    testResultsFiles: '**/surefire-reports/TEST-*.xml'

- task: Docker@2
  displayName: 'Build Docker Image'
  inputs:
    command: 'build'
    repository: '$(imageRepository)'
    dockerfile: '$(dockerfilePath)'
    containerRegistry: '$(dockerRegistryServiceConnection)'
    tags: |
      $(tag)

- task: Docker@2
  displayName: 'Push Docker Image'
  inputs:
    command: 'push'
    repository: '$(imageRepository)'
    containerRegistry: '$(dockerRegistryServiceConnection)'
    tags: |
      $(tag)

- task: PublishPipelineArtifact@1
  displayName: 'Publish YAML to artifact (for CD pipeline)'
  inputs:
    targetPath: '$(System.DefaultWorkingDirectory)'
    artifact: 'drop'
