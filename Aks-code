trigger:
- master

pool: mynewagent  # Ensure this agent has Docker/kubectl installed

variables:
  acrName: 'myacrrepo7066'  # Just the ACR name (no .azurecr.io)
  imageName: 'python-app'

steps:
- checkout: self  # Get your code

# Authenticate with ACR
- task: AzureCLI@2
  displayName: 'Login to ACR'
  inputs:
    azureSubscription: 'service-connection'
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
      az acr login --name $(acrName)

# Build and push image
- script: |
    docker build -t $(acrName).azurecr.io/$(imageName):latest .
    docker push $(acrName).azurecr.io/$(imageName):latest
  displayName: 'Build and Push'

# Deploy to AKS
- task: AzureCLI@2
  displayName: 'Deploy to AKS'
  inputs:
    azureSubscription: 'service-connection'
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
      az aks get-credentials \
        --resource-group pythonapp-rg \
        --name pythonapp-aks \
        --overwrite-existing
      kubectl apply -f k8s-deployment.yml
