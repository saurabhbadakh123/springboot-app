trigger: none

variables:
  dockerRegistryServiceConnection: 'for-modifiedcode'
  imageRepository: 'springboot-app'
  containerRegistry: 'myacrrepo7066.azurecr.io'
  dockerfilePath: 'springboot-app-main/Dockerfile'
  tag: '$(Build.BuildId)'  # Fixed variable name
  acrLoginServer: 'myacrrepo7066.azurecr.io'

pool:
  vmImage: 'ubuntu-latest'

steps:
- task: Maven@3  # Fixed typo (was Naven@3)
  inputs:
    mavenPomFile: 'springboot-app-main/pom.xml'
    goals: 'package'
    publishJUnitResults: true
    testResultsFiles: '**/surefire-reports/TEST-*.xml'
  displayName: 'Build Spring Boot App'

- task: Docker@2
  displayName: 'Build and Push Docker Image'
  inputs:
    command: 'buildAndPush'
    repository: '$(imageRepository)'  # Fixed parentheses
    dockerfile: '$(dockerfilePath)'   # Fixed parentheses
    containerRegistry: '$(dockerRegistryServiceConnection)'  # Fixed parentheses
    tags: '$(tag)'

- task: AzureCLI@2  # More reliable than plain script
  displayName: 'Validate ACR Image'
  inputs:
    azureSubscription: 'for-modifiedcode'  # Same as dockerRegistryServiceConnection
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
      echo "Verifying image exists: $(acrLoginServer)/$(imageRepository):$(tag)"
      az acr repository show \
        --name myacrrepo7066 \
        --image $(imageRepository):$(tag) || exit 1
