FROM python:3.9-slim

# Create and set workdir PROPERLY
RUN mkdir -p /app
WORKDIR /app

# Copy requirements FIRST (with absolute dest path)
COPY requirements.txt /app/requirements.txt

# Install dependencies
RUN pip install --no-cache-dir -r /app/requirements.txt

# Copy ALL files (using absolute paths)
COPY . /app/

# Run command
CMD ["python", "app.py"]

steps:
- checkout: self

# Clean up any previous build context
- script: |
    docker system prune -a -f
    echo "##[section] Current directory contents:"
    ls -la
    echo "##[section] Dockerfile contents:"
    cat Dockerfile
  displayName: 'Clean and Verify'

- task: Docker@2
  displayName: 'Build and Push'
  inputs:
    command: 'buildAndPush'
    repository: $(imageName)
    dockerfile: 'Dockerfile'
    containerRegistry: 'python-sc'
    buildContext: '.'  # Explicitly set build context
    tags: |
      latest
      $(Build.BuildId)
